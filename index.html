<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Anton Oilfield Services DMCC - Driving Record</title>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<style>
body {
    font-family: Arial, sans-serif;
    margin: 10px;
    background-color: #f5f5f5;
}
.header {
    text-align: center;
    margin-bottom: 15px;
}
.company-logo {
    height: 25px;
    margin-bottom: 5px;
}
.form-section {
    background: white;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    margin-bottom: 15px;
}
.form-group {
    margin-bottom: 10px;
}
label {
    display: block;
    margin-bottom: 3px;
    font-weight: bold;
    color: #444;
    font-size: 14px;
}
input, select, button {
    width: 100%;
    padding: 6px;
    margin-bottom: 8px;
    border: 1px solid #ddd;
    border-radius: 3px;
    box-sizing: border-box;
    font-size: 14px;
}
button {
    background-color: #1AAD19;
    color: white;
    border: none;
    cursor: pointer;
    padding: 8px 0;
    font-size: 14px;
}
#export-container {
    display: none;
    width: 100%;
    max-width: 300px;
    margin: 10px auto;
    background: white;
    padding: 10px;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    font-size: 13px;
}
.export-logo {
    height: 25px;
    margin: 0 auto 8px;
}
.export-title {
    text-align: center;
    font-size: 14px;
    margin-bottom: 8px;
    padding-bottom: 6px;
    border-bottom: 1px solid #eee;
}
#qrcode-section {
    text-align: center;
    margin: 8px 0;
}
#qrcode-section canvas {
    width: 90px !important;
    height: 90px !important;
}
.summary-item {
    margin: 5px 0;
    padding: 6px;
    background: #f8f9fa;
    border-radius: 4px;
}
.summary-label {
    color: #666;
    font-weight: bold;
    display: inline-block;
    width: 80px;
    font-size: 13px;
}
.total-cost {
    background: #e3f2fd !important;
    border: 1px solid #bbdefb;
}
.overtime-details {
    background: #fff3e0;
    padding: 8px;
    border-radius: 4px;
    margin: 8px 0;
}
.overtime-row {
    display: flex;
    justify-content: space-between;
    margin: 3px 0;
    font-size: 12px;
    line-height: 1.4;
}
button[onclick="saveDraft()"] {
    background-color: #666 !important;
    margin-bottom: 12px;
}
.hidden-item {
    display: none !important;
}
@media (max-width: 350px) {
    .summary-label {
        width: 70px;
    }
}
</style>
</head>
<body>
<div class="header">
    <img src="https://raw.githubusercontent.com/bobby520/car-log-form/main/company-logo.png"
         class="company-logo"
         alt="Company Logo">
    <h2 style="font-size:16px;">Anton Oilfield Services DMCC Driving System</h2>
</div>

<div class="form-section">
    <div class="form-group">
        <label>Driver Name:</label>
        <select id="driver" required>
            <option value="" disabled selected>Select Driver</option>
            <option value="Mudassar">Mudassar</option>
            <option value="Yusuf">Yusuf</option>
            <option value="Malik">Malik</option>
        </select>
    </div>

    <div class="form-group">
        <label>Date:</label>
        <input type="date" id="date" required>
    </div>

    <div class="form-group">
        <label>License Plate:</label>
        <select id="plate" required>
            <option value="" disabled selected>Select Vehicle</option>
            <option value="F24345">F24345</option>
            <option value="N75133">N75132</option>
            <option value="M92098">M92098</option>
            <option value="T71027">T71027</option>
            <option value="Other">Other (Manual Input)</option>
        </select>
    </div>

    <div class="form-group">
        <label>Booked by:</label>
        <input type="text" id="name" placeholder="e.g., Mr. Zhang" required>
    </div>

    <div class="form-group">
        <label>Start Time:</label>
        <input type="time" id="start-time" required>
    </div>

    <div class="form-group">
        <label>Start Odometer (KM):</label>
        <input type="number" id="start-km" placeholder="e.g., 49332" min="0" required>
    </div>

    <div class="form-group">
        <label>End Time:</label>
        <input type="time" id="end-time" required>
    </div>

    <div class="form-group">
        <label>End Odometer (KM):</label>
        <input type="number" id="end-km" placeholder="e.g., 49348" min="0" required>
    </div>

    <div class="form-group">
        <label>Fuel Cost (AED):</label>
        <input type="number" id="fuel" min="0" step="5">
    </div>

    <div class="form-group">
        <label>Parking Fee (AED):</label>
        <input type="number" id="parking" min="0" step="5">
    </div>

    <div class="form-group">
        <label>Taxi Fare (AED):</label>
        <input type="number" id="taxi" min="0" step="5">
    </div>

    <button onclick="saveDraft()">Save Draft</button>
    <button onclick="generateAndShare()">Generate QR Code</button>
</div>

<div id="export-container">
    <img src="https://raw.githubusercontent.com/bobby520/car-log-form/main/company-logo.png"
         class="export-logo"
         alt="Company Logo">
    <div class="export-title">Driving Record Summary</div>

    <div id="summary-section">
        <div class="summary-item">
            <span class="summary-label">Driver:</span>
            <span id="show-driver"></span>
        </div>
        <div class="summary-item">
            <span class="summary-label">Date:</span>
            <span id="show-date"></span>
        </div>
        <div class="summary-item">
            <span class="summary-label">License Plate:</span>
            <span id="show-plate"></span>
        </div>
        <div class="summary-item">
            <span class="summary-label">Booked by:</span>
            <span id="show-booker"></span>
        </div>
        <div class="summary-item">
            <span class="summary-label">Start Time:</span>
            <span id="show-start-time"></span>
        </div>
        <div class="summary-item">
            <span class="summary-label">End Time:</span>
            <span id="show-end-time"></span>
        </div>
        <div class="summary-item">
            <span class="summary-label">Odometer:</span>
            <span id="show-odo"></span>
        </div>
        <div class="summary-item hidden-item" id="fuel-item">
            <span class="summary-label">Fuel Cost:</span>
            <span id="show-fuel"></span>
        </div>
        <div class="summary-item hidden-item" id="parking-item">
            <span class="summary-label">Parking Fee:</span>
            <span id="show-parking"></span>
        </div>
        <div class="summary-item hidden-item" id="taxi-item">
            <span class="summary-label">Taxi Fare:</span>
            <span id="show-taxi"></span>
        </div>
        <div class="overtime-details hidden-item" id="overtime-section">
            <div class="summary-item">
                <span class="summary-label">Overtime:</span>
                <span id="show-overtime"></span>
            </div>
            <div id="overtime-breakdown"></div>
        </div>
        <div class="summary-item total-cost">
            <span class="summary-label">Total Cost:</span>
            <span id="show-total"></span>
        </div>
    </div>
    <div id="qrcode-section"></div>
</div>

<script>
let generatedImageElement = null;

document.addEventListener('DOMContentLoaded', function() {
    const dateInput = document.getElementById('date');
    const now = new Date();
    const localDate = new Date(now.getTime() - now.getTimezoneOffset() * 60000);
    dateInput.value = localDate.toISOString().substring(0, 10);
});

document.getElementById('plate').addEventListener('change', function() {
    if (this.value === 'Other') {
        const manualPlate = prompt('Enter license plate:');
        if (manualPlate) {
            const newOption = document.createElement('option');
            newOption.value = manualPlate;
            newOption.textContent = manualPlate;
            this.appendChild(newOption);
            this.value = manualPlate;
        }
    }
});

function saveDraft() {
    const driver = document.getElementById('driver').value;
    if (!driver) {
        alert('Please select driver first');
        return;
    }
    
    const formData = {
        driver: driver,
        date: document.getElementById('date').value,
        plate: document.getElementById('plate').value,
        name: document.getElementById('name').value,
        startTime: document.getElementById('start-time').value,
        startKm: document.getElementById('start-km').value,
        endTime: document.getElementById('end-time').value,
        endKm: document.getElementById('end-km').value,
        fuel: document.getElementById('fuel').value,
        parking: document.getElementById('parking').value,
        taxi: document.getElementById('taxi').value
    };
    
    localStorage.setItem(`draft_${driver}`, JSON.stringify(formData));
}

function loadDraft() {
    const driver = document.getElementById('driver').value;
    if (!driver) return;
    
    const draft = localStorage.getItem(`draft_${driver}`);
    if (draft) {
        const formData = JSON.parse(draft);
        document.getElementById('date').value = formData.date;
        document.getElementById('plate').value = formData.plate;
        document.getElementById('name').value = formData.name;
        document.getElementById('start-time').value = formData.startTime;
        document.getElementById('start-km').value = formData.startKm;
        document.getElementById('end-time').value = formData.endTime;
        document.getElementById('end-km').value = formData.endKm;
        document.getElementById('fuel').value = formData.fuel;
        document.getElementById('parking').value = formData.parking;
        document.getElementById('taxi').value = formData.taxi;
        
        if (formData.plate === 'Other') {
            const manualPlate = prompt('Enter license plate:');
            if (manualPlate) {
                const select = document.getElementById('plate');
                const newOption = document.createElement('option');
                newOption.value = manualPlate;
                newOption.textContent = manualPlate;
                select.appendChild(newOption);
                select.value = manualPlate;
            }
        }
    }
}

document.getElementById('driver').addEventListener('change', function() {
    loadDraft();
    syncFormData();
});

setInterval(() => {
    const driver = document.getElementById('driver').value;
    if (driver) saveDraft();
}, 10000);

function validateForm() {
    const requiredFields = [
        'driver', 'date', 'plate', 'name',
        'start-time', 'end-time', 'start-km', 'end-km'
    ];
    
    for (const fieldId of requiredFields) {
        const field = document.getElementById(fieldId);
        if (!field.value.trim()) {
            alert(`请填写必填字段：${field.labels[0].textContent}`);
            field.focus();
            return false;
        }
    }
    
    const startKm = +document.getElementById("start-km").value;
    const endKm = +document.getElementById("end-km").value;
    if (endKm <= startKm) {
        alert("Error: End odometer must be greater than start!");
        return false;
    }
    
    return true;
}

function calculateOvertime() {
    const start = document.getElementById('start-time').value;
    const end = document.getElementById('end-time').value;
    const dateInput = document.getElementById('date').value;

    if (!start || !end || !dateInput) return { total: 0, breakdown: [] };

    let currentDate = new Date(dateInput);
    const startDateTime = new Date(`${currentDate.toISOString().slice(0,10)}T${start}`);
    let endDateTime = new Date(`${currentDate.toISOString().slice(0,10)}T${end}`);
    
    if (endDateTime < startDateTime) endDateTime.setDate(endDateTime.getDate() + 1);

    const timeSegments = [];
    let currentStart = startDateTime;
    
    while (currentStart < endDateTime) {
        let currentEnd = new Date(currentStart);
        currentEnd.setHours(24, 0, 0, 0);
        if (currentEnd > endDateTime) currentEnd = endDateTime;
        
        timeSegments.push({
            start: new Date(currentStart),
            end: new Date(currentEnd),
            date: new Date(currentStart)
        });
        
        currentStart = new Date(currentEnd);
        currentStart.setSeconds(currentStart.getSeconds() + 1);
    }

    let totalOvertime = 0;
    const breakdown = [];

    timeSegments.forEach(segment => {
        const isWeekend = [0, 6].includes(segment.date.getDay());
        const NORMAL_START = 8;
        const NORMAL_END = 17;
        
        const calculateHours = (start, end) => {
            return Number(((end - start) / 3600000).toFixed(2));
        };

        if (!isWeekend) {
            const earlyEnd = new Date(segment.start);
            earlyEnd.setHours(NORMAL_START, 0, 0, 0);
            if (segment.start < earlyEnd) {
                const actualEnd = segment.end < earlyEnd ? segment.end : earlyEnd;
                const hours = calculateHours(segment.start, actualEnd);
                if (hours > 0) {
                    const amount = hours * 20;
                    breakdown.push({
                        type: 'Early Overtime',
                        hours: hours.toFixed(2),
                        rate: 20,
                        amount: +amount.toFixed(2),
                        date: segment.date.toISOString().slice(0,10)
                    });
                    totalOvertime += amount;
                }
            }

            const lateStart = new Date(segment.start);
            lateStart.setHours(NORMAL_END, 0, 0, 0);
            if (segment.end > lateStart) {
                const actualStart = segment.start > lateStart ? segment.start : lateStart;
                const hours = calculateHours(actualStart, segment.end);
                if (hours > 0) {
                    const amount = hours * 20;
                    breakdown.push({
                        type: 'Late Overtime',
                        hours: hours.toFixed(2),
                        rate: 20,
                        amount: +amount.toFixed(2),
                        date: segment.date.toISOString().slice(0,10)
                    });
                    totalOvertime += amount;
                }
            }
        }
        else {
            const hours = calculateHours(segment.start, segment.end);
            const amount = hours * 25;
            breakdown.push({
                type: 'Weekend Overtime',
                hours: hours.toFixed(2),
                rate: 25,
                amount: +amount.toFixed(2),
                date: segment.date.toISOString().slice(0,10)
            });
            totalOvertime += amount;
        }
    });

    return {
        total: +totalOvertime.toFixed(2),
        breakdown: breakdown
    };
}

function syncFormData() {
    document.getElementById('show-driver').textContent = document.getElementById('driver').value;
    document.getElementById('show-date').textContent = document.getElementById('date').value;
    document.getElementById('show-plate').textContent = document.getElementById('plate').value;
    document.getElementById('show-booker').textContent = document.getElementById('name').value;
    document.getElementById('show-start-time').textContent = document.getElementById('start-time').value;
    document.getElementById('show-end-time').textContent = document.getElementById('end-time').value;
    document.getElementById('show-odo').textContent =
        `${document.getElementById('start-km').value} → ${document.getElementById('end-km').value} KM`;

    const fuel = +document.getElementById('fuel').value || 0;
    const parking = +document.getElementById('parking').value || 0;
    const taxi = +document.getElementById('taxi').value || 0;
    const overtime = calculateOvertime();

    // 动态显示/隐藏费用项目
    document.getElementById('fuel-item').classList.toggle('hidden-item', fuel <= 0);
    document.getElementById('parking-item').classList.toggle('hidden-item', parking <= 0);
    document.getElementById('taxi-item').classList.toggle('hidden-item', taxi <= 0);
    document.getElementById('overtime-section').classList.toggle('hidden-item', overtime.total <= 0);

    document.getElementById('show-fuel').textContent = `${fuel} AED`;
    document.getElementById('show-parking').textContent = `${parking} AED`;
    document.getElementById('show-taxi').textContent = `${taxi} AED`;
    document.getElementById('show-overtime').textContent = `${overtime.total} AED`;

    const breakdownDiv = document.getElementById('overtime-breakdown');
    breakdownDiv.innerHTML = overtime.breakdown.map(item => `
        <div class="overtime-row">
            <span>${item.date}</span>
            <span>${item.type}</span>
            <span>${item.hours}h × ${item.rate}AED</span>
            <span>${item.amount}AED</span>
        </div>
    `).join('');

    const totalCost = fuel + parking + taxi + overtime.total;
    document.getElementById('show-total').textContent = `${totalCost.toFixed(2)} AED`;
}

async function generateAndShare() {
    if (!validateForm()) return;

    syncFormData();

    const exportContainer = document.getElementById("export-container");
    exportContainer.style.display = "flex";
    
    // 等待布局更新
    await new Promise(resolve => setTimeout(resolve, 50));

    try {
        const qrcodeDiv = document.getElementById("qrcode-section");
        qrcodeDiv.innerHTML = "";
        new QRCode(qrcodeDiv, {
            text: buildDataString(),
            width: 90,
            height: 90,
            colorDark: "#2c3e50",
            colorLight: "#ffffff",
            correctLevel: QRCode.CorrectLevel.M
        });

        const canvas = await html2canvas(exportContainer, {
            useCORS: true,
            scale: 1.5,
            windowWidth: 300,
            windowHeight: exportContainer.scrollHeight
        });

        if (generatedImageElement) generatedImageElement.remove();
        generatedImageElement = document.createElement('img');
        generatedImageElement.src = canvas.toDataURL();
        generatedImageElement.id = 'generated-image';
        document.body.appendChild(generatedImageElement);

        const link = document.createElement('a');
        link.download = `Driving_Record_${Date.now()}.png`;
        link.href = generatedImageElement.src;
        link.click();

        const driver = document.getElementById('driver').value;
        localStorage.removeItem(`draft_${driver}`);
    } catch (err) {
        alert("Generation failed, please try again");
    } finally {
        exportContainer.style.display = "none";
    }
}

function buildDataString() {
    const overtime = calculateOvertime();
    return [
        `driver:${document.getElementById("driver").value}`,
        `plate:${document.getElementById("plate").value}`,
        `date:${document.getElementById("date").value}`,
        `start_time:${document.getElementById("start-time").value}`,
        `end_time:${document.getElementById("end-time").value}`,
        `booker:${document.getElementById("name").value}`,
        `start_km:${document.getElementById("start-km").value}`,
        `end_km:${document.getElementById("end-km").value}`,
        `fuel_cost:${document.getElementById("fuel").value || 0}`,
        `parking_fee:${document.getElementById("parking").value || 0}`,
        `taxi_fare:${document.getElementById("taxi").value || 0}`,
        `overtime_details:${JSON.stringify(overtime.breakdown)}`,
        `total_cost:${(+document.getElementById("fuel").value +
            +document.getElementById("parking").value +
            +document.getElementById("taxi").value +
            overtime.total).toFixed(2)}`
    ].join("|");
}

document.getElementById('start-time').addEventListener('change', syncFormData);
document.getElementById('end-time').addEventListener('change', syncFormData);
document.getElementById('date').addEventListener('change', syncFormData);
document.getElementById('fuel').addEventListener('input', syncFormData);
document.getElementById('parking').addEventListener('input', syncFormData);
document.getElementById('taxi').addEventListener('input', syncFormData);
</script>
</body>
</html>
